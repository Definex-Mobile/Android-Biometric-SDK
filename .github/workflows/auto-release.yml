name: Auto Release on PR Merge

on:
  pull_request:
    types: [closed]
    branches:
      - master

jobs:
  create-release:
    # Only run if PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master
      
      - name: Get current version from build.gradle.kts
        id: get_version
        run: |
          VERSION=$(grep 'version = "' biometric-security-sdk/build.gradle.kts | sed 's/.*version = "\(.*\)".*/\1/')
          echo "Current version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Check if tag already exists
        id: check_tag
        run: |
          if git rev-parse "v${{ steps.get_version.outputs.version }}" >/dev/null 2>&1; then
            echo "Tag v${{ steps.get_version.outputs.version }} already exists"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Tag v${{ steps.get_version.outputs.version }} does not exist"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Git Tag
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ steps.get_version.outputs.version }}" -m "Release v${{ steps.get_version.outputs.version }}"
          git push origin "v${{ steps.get_version.outputs.version }}"
      
      - name: Generate Release Notes
        id: release_notes
        run: |
          # Create release notes header
          cat > release_notes.md << 'EOFNOTES'
          # ðŸŽ‰ Android Biometric Security SDK v${{ steps.get_version.outputs.version }}
          
          ## ðŸ“ Changes
          
          **PR #${{ github.event.pull_request.number }}**: ${{ github.event.pull_request.title }}
          
          EOFNOTES
          
          # Append PR body (safely)
          echo "${{ github.event.pull_request.body }}" >> release_notes.md
          
          # Append installation and requirements
          cat >> release_notes.md << 'EOFNOTES'
          
          ## ðŸ“¦ Installation
          
          ```kotlin
          // settings.gradle.kts
          maven { url = uri("https://jitpack.io") }
          
          // build.gradle.kts
          dependencies {
              implementation("com.github.Definex-Mobile:Android-Biometric-SDK:${{ steps.get_version.outputs.version }}")
          }
          ```
          
          ## ðŸ“„ Requirements
          
          - **Min SDK**: 28 (Android 9.0)
          - **Target SDK**: 34 (Android 14)
          - **Kotlin**: 1.9.20+
          - **Java**: 11+
          
          ## ðŸ™ Contributors
          
          - @${{ github.event.pull_request.user.login }}
          
          ---
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ steps.get_version.outputs.version }}...master
          EOFNOTES
          
          cat release_notes.md
      
      - name: Create GitHub Release
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: v${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Comment on PR
        if: steps.check_tag.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸŽ‰ Release [v${{ steps.get_version.outputs.version }}](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.get_version.outputs.version }}) has been created automatically!\n\nðŸ“¦ JitPack: https://jitpack.io/#${{ github.repository }}/${{ steps.get_version.outputs.version }}'
            })
